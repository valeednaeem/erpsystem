import { NextResponse } from "next/server";
import { execute } from "../../../../lib/db";
import { requirePermission } from "../../../../lib/apiGuard";
import { logActivity } from "../../../../lib/activityLogger";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

export async function PATCH(req: Request) {
  const auth = await requirePermission(req, "ORDER_STATUS_UPDATE");
  if (!auth.ok) {
    return NextResponse.json({ error: auth.error }, { status: auth.status });
  }

  const { order_id, status } = await req.json();

    await execute(
    `UPDATE sales_orders SET status = ? WHERE id = ?`,
    [status, order_id]
  );

  await logActivity(auth.userId, "UPDATE_STATUS", "sales_orders", order_id);

  return NextResponse.json({ success: true });
}
